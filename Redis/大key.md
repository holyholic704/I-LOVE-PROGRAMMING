## 大 key

大 key 并不是指 key 的值很大，而是指 key 对应的 value 很大

- string 类型的值大于 10 KB
- hash、list、set、zset 类型的元素的个数超过 5000 个
  - 个数多并不代表内存占用也多，主要考虑的还是内存的占用

### 有何影响

#### 客户端超时阻塞

因为 Redis 执行命令是单线程的，在操作大 key 时会比较耗时，会阻塞 Redis

#### 引发网络阻塞

每次获取大 key 产生的网络流量都比较大，请求这些大 key 的频率越高，造成网络阻塞的可能性越大

#### 阻塞工作线程

如果使用 del 命令删除大 key，会阻塞工作线程

#### 内存分布不均

集群模型在 slot 分片均匀情况下，会出现数据和查询倾斜情况，部分有大 key 的节点占用内存多，QPS 也会比较大

### 如何查找

#### 使用 `redis-cli --bigkeys` 命令

会阻塞 Redis ，生产环境慎用，如果配置了主从，可以在从节点上执行

- 只能返回每种类型中最大的那个大 key
- 对于集合类型，只能统计中元素的个数，而不是实际占用的内存

#### 使用 `scan` 命令

`scan` 命令可以按照一定的模式和数量返回匹配的 key，获取了 key 之后，再根据类型，使用对应的命令返回长度或元素个数

Redis 4.0 之后，可以使用 `memory usage <key>` 查询占用的内存大小

#### 使用 redis-rdb-tools 扫描 RDB 文件

使用第三方工具扫描 RDB 文件，实时性较差，但不影响使用

### 如何处理

可以对大 key 进行拆分，采用合适的数据结构，手动清理，这些方案都绕不过删除。如果一下子把大 key 都删除了，可能会对主线程产生阻塞，其他所有请求可能都会超时，超时越来越多，会造成 Redis 连接耗尽，产生各种异常

#### 分批删除

获取到大 key，再分批次进行删除

#### 异步删除

Redis 4.0 之后可以使用异步删除法，用 unlink 命令代替 del 来删除，Redis 会将 key 放入到一个异步线程中进行删除，这样就不会阻塞主线程了

## 参考

- [面试官：Redis 大 key 要如何处理？](https://mp.weixin.qq.com/s?__biz=MzUxODAzNDg4NQ==&mid=2247518433&idx=2&sn=e78f630c07f4e60fb78999eb3d742e9e&chksm=f98dcc4bcefa455d8ffde9ad6c8da9b3371a401766a55cbee7af11c87be070d823c8d5926aef&scene=178&cur_album_id=1790401816640225283)