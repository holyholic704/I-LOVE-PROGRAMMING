## 过期删除策略

在 Redis 中为 key 设置过期时间，Redis 会将该 key 带上过期时间存储到一个过期字典（expires dict）中

![](./md.assets/expire_dict.png)

过期字典里保存了指向某个键对象的指针，和过期时间的时间戳

Redis 在查询的时候，会首先查看该 key 是否在过期字典中，如果不在，则正常读取键值，如果在，则会先判断该 key 是否过期

![](./md.assets/isexpire.png)

### 删除策略

#### 定时删除（立即删除）

在设置 key 的过期时间时，Redis 会同时创建一个定时器，到了过期时间，定时器会立即执行 key 的删除操作，**对内存友好，对 CPU 不友好**

- 优点：保证过期 key 会被尽快删除，内存也可以被尽快地释放
- 缺点：在过期 key 比较多的情况下，删除过期 key 可能会占用相当一部分 CPU 时间，会对服务器的响应时间和吞吐量造成影响

#### 惰性删除

不主动删除过期键，每当访问该 key 时，都检测其是否过期，如果过期则删除该 key，**对 CPU 友好，对内存不友好**

- 优点：当真正访问该 key 时，才会检查 key 是否过期，只会使用很少的系统资源
- 缺点：key 过期了，仍会留在内存中，如果该 key 一直没有被访问，占用的内存也不会被释放

#### 定期删除

每隔一段时间 **随机** 从数据库中取出一定数量的 key 进行检查，并删除其中的过期 key，是定时删除与惰性删除的折中方案

- 优点：通过调整删除操作执行的时长和频率，来减少对 CPU 的影响，同时也能删除一部分过期的数据，减少了过期键对空间的无效占用
- 缺点：效率不如定时删除，资源占用比惰性删除多。难以确定删除操作执行的时长和频率，过多或过少都不好

##### 执行过程

1. 默认每隔 10 秒，从过期字典中随机抽取 20 个 key
2. 删除这 20 个 key 中已经过期的 key
3. 如果过期的 key 比率超过 1/4，重复步骤 1

为了保证定期删除不会出现循环过度，导致线程卡死现象，为此 Redis 增加了定期删除循环流程的时间上限，默认不会超过 25ms

#### Redis 的选择

Redis 采用的是 **惰性删除 + 定期删除** 策略，以求在合理使用 CPU 时间和避免内存浪费之间取得平衡，即在 Redis 中如果 key 过期了，**不一定会被马上删除**